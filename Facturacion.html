<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturación FisioSport</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
            margin-top: 0;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }
        
        h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        /* Estilo mejorado para la información del Paciente*/
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .patient-info .form-group {
            margin-bottom: 15px;
        }
        
        .patient-info label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .patient-info input, 
        .patient-info select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .patient-info input:focus, 
        .patient-info select:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background-color: white;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 15px;
        }
        
        th, td {
            border: 1px solid #e0e0e0;
            padding: 12px 15px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        input, select {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 6px;
            margin-right: 10px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background-color: #7f8c8d;
        }
        
        button.danger {
            background-color: var(--accent-color);
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.info {
            background-color: #16a085;
        }
        
        .total {
            font-weight: bold;
            font-size: 1.2em;
            text-align: right;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .hidden {
            display: none;
        }
        
        /* Estilo para el área de impresión A4 */
        .print-area {
            width: 210mm;
            min-height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        /* Estilo para el área de reportes */
        .report-area {
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area *,
            .report-area, .report-area * {
                visibility: visible;
            }
            .print-area, .report-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 15mm;
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
            .no-print {
                display: none !important;
            }
            @page {
                size: A4;
                margin: 10mm;
            }
        }
        
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .logo h2 {
            color: var(--secondary-color);
            font-size: 1.8em;
            margin: 10px 0;
            border-bottom: none;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .invoice-info {
            text-align: right;
        }
        
        .signature-area {
            margin-top: 60px;
            text-align: center;
        }
        
        .signature-line {
            width: 300px;
            border-top: 1px solid #000;
            margin: 0 auto;
            padding-top: 5px;
        }
        
        .eliminar-servicio {
            padding: 6px 10px;
            font-size: 14px;
            background-color: var(--accent-color);
        }
        
        .eliminar-servicio:hover {
            background-color: #c0392b;
        }
        
        .report-summary {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .report-summary p {
            margin: 5px 0;
            font-size: 1.1em;
        }
        
        .report-summary .total {
            font-size: 1.3em;
            color: var(--primary-color);
        }
        
        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .report-filters select, 
        .report-filters input {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .report-actions {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Facturación FisioSport</h1>
        
        <!-- Sección de información del paciente -->
        <div class="section">
            <h2>Información del Paciente</h2>
            <div class="patient-info">
                <div class="form-group">
                    <label for="paciente-nombre">Nombre completo:</label>
                    <input type="text" id="paciente-nombre" required>
                </div>
                
                <div class="form-group">
                    <label for="paciente-identificacion">Identificación:</label>
                    <input type="text" id="paciente-identificacion" required>
                </div>
                
                <div class="form-group">
                    <label for="paciente-edad">Edad:</label>
                    <input type="number" id="paciente-edad" min="0" max="120" required>
                </div>
                
                <div class="form-group">
                    <label for="paciente-genero">Género:</label>
                    <select id="paciente-genero" required>
                        <option value="">Seleccione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>                        
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paciente-telefono">Teléfono:</label>
                    <input type="tel" id="paciente-telefono">
                </div>
                
                <div class="form-group">
                    <label for="paciente-seguro">Seguro médico:</label>
                    <input type="text" id="paciente-seguro">
                </div>
            </div>
        </div>
        
        <!-- Sección de servicios médicos -->
        <div class="section">
            <h2>Servicios Realizados</h2>
            <table id="servicios-table">
                <thead>
                    <tr>
                        <th width="30%">Servicio</th>
                        <th width="15%">Cantidad</th>
                        <th width="20%">Precio Unitario</th>
                        <th width="20%">Subtotal</th>
                        <th width="15%">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select class="servicio-select">
                                <option value="">Seleccione servicio</option>
                                <option value="Terapia Física">Terapia Física</option>
                                <option value="Consulta General">Consulta General</option>
                                <option value="Consulta Especializada">Consulta Especializada</option>
                                <option value="Ecografía">Ecografía</option>
                                <option value="Ondas de Choque">Ondas de Choque</option>
                                <option value="Terapia Regenerativa">Terapia Regenerativa</option>
                                <option value="Suero Terapia">Suero Terapia</option>
                                <option value="Masaje">Masaje</option>
                            </select>
                        </td>
                        <td><input type="number" class="servicio-cantidad" min="1" value="1"></td>
                        <td><input type="number" class="servicio-precio" min="0" step="0.01"></td>
                        <td class="servicio-subtotal">0.00</td>
                        <td><button class="eliminar-servicio">Eliminar</button></td>
                    </tr>
                </tbody>
            </table>
            <button id="agregar-servicio" class="success">Agregar Servicio</button>
        </div>
        
        <!-- Sección de resumen y total -->
        <div class="section">
            <h2>Resumen de Factura</h2>
            <div id="resumen-factura">
                <p>Total Servicios: <span id="total-servicios">0.00</span></p>
                <p>Subtotal: <span id="subtotal">0.00</span></p>
                <p>Descuento (%): <input type="number" id="descuento" min="0" max="100" value="0" style="width: 80px;"></p>
                <p>IVA (%): <input type="number" id="iva" min="0" max="100" value="0" style="width: 80px;"></p>
                <div class="total">Total a Pagar: <span id="total-pagar">0.00</span></div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="section no-print">
            <button id="calcular-total">Calcular Total</button>
            <button id="generar-factura">Generar Factura</button>
            <button id="limpiar-formulario" class="secondary">Limpiar Formulario</button>
            <button id="guardar-factura" class="success">Guardar Factura</button>
            <button id="cargar-factura">Cargar Factura</button>
            <button id="generar-reporte" class="info">Generar Reporte</button>
        </div>
        
        <!-- Área de impresión de factura (oculta inicialmente) -->
        <div id="print-area" class="print-area hidden">
            <div class="logo">
                <h2>FisioSport</h2>
                <p>Centro de Terapia Física y Rehabilitación</p>
                <p>Teléfono: 809-499-1221 | Email: fisiosportdr@gmail.com</p>
            </div>
            
            <div class="invoice-header">
                <div>
                    <h3>Factura</h3>
                </div>
                <div class="invoice-info">
                    <p><strong>Fecha:</strong> <span id="factura-fecha"></span></p>
                    <p><strong>N° Factura:</strong> <span id="factura-numero"></span></p>
                </div>
            </div>
            
            <h3>Información del Paciente</h3>
            <table>
                <tr>
                    <td width="25%"><strong>Nombre:</strong></td>
                    <td width="25%" id="factura-paciente-nombre"></td>
                    <td width="25%"><strong>Identificación:</strong></td>
                    <td width="25%" id="factura-paciente-identificacion"></td>
                </tr>
                <tr>
                    <td><strong>Edad:</strong></td>
                    <td id="factura-paciente-edad"></td>
                    <td><strong>Género:</strong></td>
                    <td id="factura-paciente-genero"></td>
                </tr>
                <tr>
                    <td><strong>Teléfono:</strong></td>
                    <td id="factura-paciente-telefono"></td>
                    <td><strong>Seguro médico:</strong></td>
                    <td id="factura-paciente-seguro"></td>
                </tr>
            </table>
            
            <h3>Detalle de Servicios</h3>
            <table id="factura-servicios">
                <thead>
                    <tr>
                        <th>Servicio</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div class="total">
                <p>Subtotal: $<span id="factura-subtotal">0.00</span></p>
                <p>Descuento: $<span id="factura-descuento">0.00</span> (<span id="factura-descuento-porcentaje">0</span>%)</p>
                <p>IVA: $<span id="factura-iva">0.00</span> (<span id="factura-iva-porcentaje">0</span>%)</p>
                <p><strong>TOTAL A PAGAR:</strong> $<span id="factura-total">0.00</span></p>
            </div>
            
            <div class="signature-area">
                <div class="signature-line"></div>
                <p>Firma del Terapeuta</p>
            </div>
            
            <div style="margin-top: 40px; font-size: 12px; text-align: center;">
                <p>FisioSport - Centro de Terapia Física y Rehabilitación</p>
                <p>Gracias por su preferencia</p>
            </div>
            
            <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 10px 20px;">Imprimir Factura</button>
                <button onclick="document.getElementById('print-area').classList.add('hidden')" style="padding: 10px 20px; margin-left: 20px;">Cerrar Factura</button>
            </div>
        </div>
        
        <!-- Área de reportes (oculta inicialmente) -->
        <div id="report-area" class="report-area hidden">
            <div class="logo">
                <h2>FisioSport</h2>
                <p>Centro de Terapia Física y Rehabilitación</p>
                <p>Teléfono: 809-499-1221 | Email: fisiosportdr@gmail.com</p>
            </div>
            
            <div class="invoice-header">
                <div>
                    <h3>Reporte de Facturas</h3>
                    <p id="report-period"></p>
                </div>
                <div class="invoice-info">
                    <p><strong>Fecha de generación:</strong> <span id="report-generation-date"></span></p>
                </div>
            </div>
            
            <div class="no-print report-filters">
                <select id="report-type">
                    <option value="daily">Diario</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensual</option>
                    <option value="custom">Personalizado</option>
                </select>
                
                <input type="date" id="report-date" style="display: inline-block;">
                
                <div id="custom-range" style="display: none;">
                    <input type="date" id="report-start-date">
                    <span>a</span>
                    <input type="date" id="report-end-date">
                </div>
                
                <button id="apply-report-filters" class="info">Aplicar Filtros</button>
            </div>
            
            <div class="report-summary">
                <p><strong>Resumen del Reporte</strong></p>
                <p>Total Facturas: <span id="report-total-invoices">0</span></p>
                <p>Total Ingresos: $<span id="report-total-income">0.00</span></p>
                <p>Promedio por Factura: $<span id="report-average">0.00</span></p>
                <p class="total">Total General: $<span id="report-grand-total">0.00</span></p>
            </div>
            
            <h3>Detalle de Facturas</h3>
            <table id="report-invoices">
                <thead>
                    <tr>
                        <th>N° Factura</th>
                        <th>Fecha</th>
                        <th>Paciente</th>
                        <th>Identificación</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <div class="no-print report-actions">
                <button onclick="window.print()" style="padding: 10px 20px;">Imprimir Reporte</button>
                <button onclick="document.getElementById('report-area').classList.add('hidden')" style="padding: 10px 20px; margin-left: 20px;">Cerrar Reporte</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let facturasGuardadas = JSON.parse(localStorage.getItem('facturasFisioSport')) || [];
        let contadorFacturas = facturasGuardadas.length > 0 ? 
            Math.max(...facturasGuardadas.map(f => parseInt(f.numero))) + 1 : 1;
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar filas a las tablas
            document.getElementById('agregar-servicio').addEventListener('click', agregarFilaServicio);
            
            // Calcular total
            document.getElementById('calcular-total').addEventListener('click', calcularTotal);
            
            // Generar factura
            document.getElementById('generar-factura').addEventListener('click', generarFactura);
            
            // Limpiar formulario
            document.getElementById('limpiar-formulario').addEventListener('click', limpiarFormulario);
            
            // Guardar factura
            document.getElementById('guardar-factura').addEventListener('click', guardarFactura);
            
            // Cargar factura
            document.getElementById('cargar-factura').addEventListener('click', cargarFactura);
            
            // Generar reporte
            document.getElementById('generar-reporte').addEventListener('click', mostrarFiltrosReporte);
            
            // Aplicar filtros de reporte
            document.getElementById('apply-report-filters').addEventListener('click', generarReporte);
            
            // Cambiar tipo de reporte
            document.getElementById('report-type').addEventListener('change', function() {
                const tipo = this.value;
                document.getElementById('report-date').style.display = 
                    (tipo === 'daily' || tipo === 'weekly' || tipo === 'monthly') ? 'inline-block' : 'none';
                document.getElementById('custom-range').style.display = 
                    tipo === 'custom' ? 'block' : 'none';
            });
            
            // Eventos delegados para eliminar filas
            document.getElementById('servicios-table').addEventListener('click', function(e) {
                if (e.target.classList.contains('eliminar-servicio')) {
                    if (document.querySelectorAll('#servicios-table tbody tr').length > 1) {
                        e.target.closest('tr').remove();
                        calcularTotal();
                    } else {
                        alert('Debe haber al menos un servicio');
                    }
                }
            });
            
            // Eventos para calcular subtotales automáticamente
            document.getElementById('servicios-table').addEventListener('input', function(e) {
                if (e.target.classList.contains('servicio-cantidad') || 
                    e.target.classList.contains('servicio-precio')) {
                    calcularSubtotal(e.target.closest('tr'));
                }
            });
            
            // Eventos para actualizar total cuando cambian descuento o IVA
            document.getElementById('descuento').addEventListener('input', calcularTotal);
            document.getElementById('iva').addEventListener('input', calcularTotal);
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-date').value = today;
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
        });
        
        // Funciones
        function agregarFilaServicio() {
            const tbody = document.querySelector('#servicios-table tbody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>
                    <select class="servicio-select">
                        <option value="">Seleccione servicio</option>
                        <option value="Terapia Física">Terapia Física</option>
                        <option value="Consulta General">Consulta General</option>
                        <option value="Consulta Especializada">Consulta Especializada</option>
                        <option value="Ecografía">Ecografía</option>
                        <option value="Ondas de Choque">Ondas de Choque</option>
                        <option value="Terapia Regenerativa">Terapia Regenerativa</option>
                        <option value="Suero Terapia">Suero Terapia</option>
                        <option value="Masaje">Masaje</option>
                    </select>
                </td>
                <td><input type="number" class="servicio-cantidad" min="1" value="1"></td>
                <td><input type="number" class="servicio-precio" min="0" step="0.01"></td>
                <td class="servicio-subtotal">0.00</td>
                <td><button class="eliminar-servicio">Eliminar</button></td>
            `;
            tbody.appendChild(newRow);
        }
        
        function calcularSubtotal(row) {
            const cantidad = parseFloat(row.querySelector('.servicio-cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.servicio-precio').value) || 0;
            const subtotal = cantidad * precio;
            row.querySelector('.servicio-subtotal').textContent = subtotal.toFixed(2);
        }
        
        function calcularTotal() {
            // Calcular total servicios
            let totalServicios = 0;
            document.querySelectorAll('#servicios-table .servicio-subtotal').forEach(cell => {
                totalServicios += parseFloat(cell.textContent) || 0;
            });
            document.getElementById('total-servicios').textContent = totalServicios.toFixed(2);
            
            // Calcular subtotal
            const subtotal = totalServicios;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            
            // Aplicar descuento
            const descuentoPorcentaje = parseFloat(document.getElementById('descuento').value) || 0;
            const descuento = subtotal * (descuentoPorcentaje / 100);
            
            // Aplicar IVA
            const ivaPorcentaje = parseFloat(document.getElementById('iva').value) || 0;
            const iva = (subtotal - descuento) * (ivaPorcentaje / 100);
            
            // Calcular total
            const total = subtotal - descuento + iva;
            document.getElementById('total-pagar').textContent = total.toFixed(2);
        }
        
        function generarFactura() {
            // Validar datos del paciente
            const pacienteNombre = document.getElementById('paciente-nombre').value;
            const pacienteIdentificacion = document.getElementById('paciente-identificacion').value;
            
            if (!pacienteNombre || !pacienteIdentificacion) {
                alert('Por favor complete el nombre y la identificación del paciente');
                return;
            }
            
            // Validar que haya al menos un servicio
            const servicios = document.querySelectorAll('#servicios-table tbody tr');
            
            if (servicios.length === 0) {
                alert('Debe agregar al menos un servicio');
                return;
            }
            
            // Actualizar datos en la factura
            const now = new Date();
            document.getElementById('factura-fecha').textContent = now.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('factura-numero').textContent = contadorFacturas.toString().padStart(4, '0');
            
            // Datos del paciente
            document.getElementById('factura-paciente-nombre').textContent = pacienteNombre;
            document.getElementById('factura-paciente-identificacion').textContent = document.getElementById('paciente-identificacion').value;
            document.getElementById('factura-paciente-edad').textContent = document.getElementById('paciente-edad').value;
            document.getElementById('factura-paciente-genero').textContent = document.getElementById('paciente-genero').value;
            document.getElementById('factura-paciente-telefono').textContent = document.getElementById('paciente-telefono').value || 'N/A';
            document.getElementById('factura-paciente-seguro').textContent = document.getElementById('paciente-seguro').value || 'N/A';
            
            // Servicios
            const facturaServiciosTbody = document.querySelector('#factura-servicios tbody');
            facturaServiciosTbody.innerHTML = '';
            
            servicios.forEach(servicio => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${servicio.querySelector('.servicio-select').value}</td>
                    <td>${servicio.querySelector('.servicio-cantidad').value}</td>
                    <td>$${parseFloat(servicio.querySelector('.servicio-precio').value).toFixed(2)}</td>
                    <td>$${servicio.querySelector('.servicio-subtotal').textContent}</td>
                `;
                facturaServiciosTbody.appendChild(row);
            });
            
            // Totales
            const subtotal = parseFloat(document.getElementById('subtotal').textContent);
            const descuentoPorcentaje = parseFloat(document.getElementById('descuento').value) || 0;
            const descuento = subtotal * (descuentoPorcentaje / 100);
            const ivaPorcentaje = parseFloat(document.getElementById('iva').value) || 0;
            const iva = (subtotal - descuento) * (ivaPorcentaje / 100);
            const total = parseFloat(document.getElementById('total-pagar').textContent);
            
            document.getElementById('factura-subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('factura-descuento').textContent = descuento.toFixed(2);
            document.getElementById('factura-descuento-porcentaje').textContent = descuentoPorcentaje;
            document.getElementById('factura-iva').textContent = iva.toFixed(2);
            document.getElementById('factura-iva-porcentaje').textContent = ivaPorcentaje;
            document.getElementById('factura-total').textContent = total.toFixed(2);
            
            // Mostrar área de impresión
            document.getElementById('print-area').classList.remove('hidden');
            
            // Desplazarse al área de impresión
            document.getElementById('print-area').scrollIntoView({ behavior: 'smooth' });
        }
        
        function limpiarFormulario() {
            if (confirm('¿Está seguro que desea limpiar el formulario? Se perderán todos los datos no guardados.')) {
                // Limpiar datos del paciente
                document.getElementById('paciente-nombre').value = '';
                document.getElementById('paciente-identificacion').value = '';
                document.getElementById('paciente-edad').value = '';
                document.getElementById('paciente-genero').value = '';
                document.getElementById('paciente-telefono').value = '';
                document.getElementById('paciente-seguro').value = '';
                
                // Limpiar servicios (dejar solo una fila)
                const serviciosTbody = document.querySelector('#servicios-table tbody');
                serviciosTbody.innerHTML = '';
                agregarFilaServicio();
                
                // Limpiar totales
                document.getElementById('descuento').value = '0';
                document.getElementById('iva').value = '0';
                calcularTotal();
                
                // Ocultar factura si está visible
                document.getElementById('print-area').classList.add('hidden');
            }
        }
        
        function guardarFactura() {
            // Validar que haya datos para guardar
            const pacienteNombre = document.getElementById('paciente-nombre').value;
            const pacienteIdentificacion = document.getElementById('paciente-identificacion').value;
            
            if (!pacienteNombre || !pacienteIdentificacion) {
                alert('No hay datos de paciente para guardar');
                return;
            }
            
            // Recolectar datos del paciente
            const paciente = {
                nombre: pacienteNombre,
                identificacion: pacienteIdentificacion,
                edad: document.getElementById('paciente-edad').value,
                genero: document.getElementById('paciente-genero').value,
                telefono: document.getElementById('paciente-telefono').value,
                seguro: document.getElementById('paciente-seguro').value
            };
            
            // Recolectar servicios
            const servicios = [];
            document.querySelectorAll('#servicios-table tbody tr').forEach(row => {
                servicios.push({
                    servicio: row.querySelector('.servicio-select').value,
                    cantidad: row.querySelector('.servicio-cantidad').value,
                    precio: row.querySelector('.servicio-precio').value,
                    subtotal: row.querySelector('.servicio-subtotal').textContent
                });
            });
            
            // Recolectar totales
            const totales = {
                subtotal: document.getElementById('subtotal').textContent,
                descuento: document.getElementById('descuento').value,
                iva: document.getElementById('iva').value,
                total: document.getElementById('total-pagar').textContent
            };
            
            // Crear objeto de factura
            const factura = {
                numero: contadorFacturas,
                fecha: new Date().toISOString(),
                paciente,
                servicios,
                totales
            };
            
            // Agregar a las facturas guardadas
            facturasGuardadas.push(factura);
            localStorage.setItem('facturasFisioSport', JSON.stringify(facturasGuardadas));
            
            // Incrementar contador
            contadorFacturas++;
            
            alert(`Factura #${factura.numero} guardada correctamente`);
        }
        
        function cargarFactura() {
            if (facturasGuardadas.length === 0) {
                alert('No hay facturas guardadas');
                return;
            }
            
            // Mostrar lista de facturas para seleccionar
            const facturaNumero = prompt(`Facturas disponibles (${facturasGuardadas.length}):\n` + 
                facturasGuardadas.map(f => `#${f.numero} - ${f.paciente.nombre} (${new Date(f.fecha).toLocaleDateString()})`).join('\n') + 
                '\n\nIngrese el número de factura a cargar:');
            
            if (!facturaNumero) return;
            
            const factura = facturasGuardadas.find(f => f.numero === parseInt(facturaNumero));
            
            if (!factura) {
                alert('Factura no encontrada');
                return;
            }
            
            // Limpiar formulario primero
            limpiarFormulario();
            
            // Cargar datos del paciente
            document.getElementById('paciente-nombre').value = factura.paciente.nombre;
            document.getElementById('paciente-identificacion').value = factura.paciente.identificacion;
            document.getElementById('paciente-edad').value = factura.paciente.edad;
            document.getElementById('paciente-genero').value = factura.paciente.genero;
            document.getElementById('paciente-telefono').value = factura.paciente.telefono;
            document.getElementById('paciente-seguro').value = factura.paciente.seguro;
            
            // Cargar servicios
            const serviciosTbody = document.querySelector('#servicios-table tbody');
            serviciosTbody.innerHTML = '';
            
            factura.servicios.forEach((serv, index) => {
                if (index > 0) agregarFilaServicio();
                const rows = document.querySelectorAll('#servicios-table tbody tr');
                const row = rows[rows.length - 1];
                
                row.querySelector('.servicio-select').value = serv.servicio;
                row.querySelector('.servicio-cantidad').value = serv.cantidad;
                row.querySelector('.servicio-precio').value = serv.precio;
                row.querySelector('.servicio-subtotal').textContent = serv.subtotal;
            });
            
            // Cargar totales
            document.getElementById('descuento').value = factura.totales.descuento;
            document.getElementById('iva').value = factura.totales.iva;
            
            // Calcular total para actualizar los campos
            calcularTotal();
            
            alert(`Factura #${factura.numero} cargada correctamente`);
        }
        
        function mostrarFiltrosReporte() {
            // Mostrar área de reportes
            document.getElementById('report-area').classList.remove('hidden');
            
            // Establecer fecha de generación
            const now = new Date();
            document.getElementById('report-generation-date').textContent = now.toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Desplazarse al área de reportes
            document.getElementById('report-area').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generarReporte() {
            const tipoReporte = document.getElementById('report-type').value;
            const fecha = document.getElementById('report-date').value;
            const fechaInicio = document.getElementById('report-start-date').value;
            const fechaFin = document.getElementById('report-end-date').value;
            
            let facturasFiltradas = [];
            let periodoTexto = '';
            
            // Filtrar facturas según el tipo de reporte
            switch(tipoReporte) {
                case 'daily':
                    facturasFiltradas = facturasGuardadas.filter(f => {
                        const fechaFactura = new Date(f.fecha).toISOString().split('T')[0];
                        return fechaFactura === fecha;
                    });
                    periodoTexto = `Diario - ${new Date(fecha).toLocaleDateString('es-ES')}`;
                    break;
                    
                case 'weekly':
                    const fechaSeleccionada = new Date(fecha);
                    const diaSemana = fechaSeleccionada.getDay();
                    const inicioSemana = new Date(fechaSeleccionada);
                    inicioSemana.setDate(fechaSeleccionada.getDate() - diaSemana);
                    const finSemana = new Date(fechaSeleccionada);
                    finSemana.setDate(fechaSeleccionada.getDate() + (6 - diaSemana));
                    
                    facturasFiltradas = facturasGuardadas.filter(f => {
                        const fechaFactura = new Date(f.fecha);
                        return fechaFactura >= inicioSemana && fechaFactura <= finSemana;
                    });
                    
                    periodoTexto = `Semanal - Del ${inicioSemana.toLocaleDateString('es-ES')} al ${finSemana.toLocaleDateString('es-ES')}`;
                    break;
                    
                case 'monthly':
                    const fechaMes = new Date(fecha);
                    const primerDiaMes = new Date(fechaMes.getFullYear(), fechaMes.getMonth(), 1);
                    const ultimoDiaMes = new Date(fechaMes.getFullYear(), fechaMes.getMonth() + 1, 0);
                    
                    facturasFiltradas = facturasGuardadas.filter(f => {
                        const fechaFactura = new Date(f.fecha);
                        return fechaFactura >= primerDiaMes && fechaFactura <= ultimoDiaMes;
                    });
                    
                    periodoTexto = `Mensual - ${fechaMes.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
                    break;
                    
                case 'custom':
                    const inicio = new Date(fechaInicio);
                    const fin = new Date(fechaFin);
                    
                    facturasFiltradas = facturasGuardadas.filter(f => {
                        const fechaFactura = new Date(f.fecha);
                        return fechaFactura >= inicio && fechaFactura <= fin;
                    });
                    
                    periodoTexto = `Personalizado - Del ${inicio.toLocaleDateString('es-ES')} al ${fin.toLocaleDateString('es-ES')}`;
                    break;
            }
            
            // Mostrar el período del reporte
            document.getElementById('report-period').textContent = periodoTexto;
            
            // Mostrar las facturas en la tabla
            const tbody = document.querySelector('#report-invoices tbody');
            tbody.innerHTML = '';
            
            let totalGeneral = 0;
            
            facturasFiltradas.forEach(factura => {
                const row = document.createElement('tr');
                const totalFactura = parseFloat(factura.totales.total);
                totalGeneral += totalFactura;
                
                row.innerHTML = `
                    <td>${factura.numero}</td>
                    <td>${new Date(factura.fecha).toLocaleDateString('es-ES')}</td>
                    <td>${factura.paciente.nombre}</td>
                    <td>${factura.paciente.identificacion}</td>
                    <td>$${totalFactura.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Actualizar resumen del reporte
            document.getElementById('report-total-invoices').textContent = facturasFiltradas.length;
            document.getElementById('report-total-income').textContent = totalGeneral.toFixed(2);
            
            const promedio = facturasFiltradas.length > 0 ? 
                (totalGeneral / facturasFiltradas.length).toFixed(2) : '0.00';
            document.getElementById('report-average').textContent = promedio;
            
            document.getElementById('report-grand-total').textContent = totalGeneral.toFixed(2);
        }
    </script>
</body>
</html>